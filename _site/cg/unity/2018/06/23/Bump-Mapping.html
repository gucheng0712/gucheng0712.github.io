<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1; minimum-scale=1; user-scalable=no;"> <meta name="author" content="ChengGu"> <meta name="baseurl" content=""> <title> Suzuka Site|Bump Mapping </title> <!-- favicon --> <link rel="shortcut icon" href="/static/assets/img/favicon.ico"> <!-- Main CSS --> <link href="/static/assets/app-20180125.min.css" rel="stylesheet"> <link href="/static/css/custom.css" rel="stylesheet"> <!-- Main Scripts --> <script src="/static/assets/app-20180125.min.js"></script> <script src="/static/assets/blog-20180125.min.js"></script> <!-- Google AdSense --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-6196184668650108", enable_page_level_ads: true }); </script> </head> <body id="page-top" class="landing-page"> <div class="search-tool" style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right: 0px; opacity: 0.95; background-color: #111111; z-index: 9999; display: none;"> <input type="text" class="form-control search-content" id="search-content" style="position: fixed; top: 60px" placeholder="Search Blog"> <div style="position: fixed; top: 16px; right: 16px; z-index: 9999;"> <img src=" /static/assets/img/search/cb-close.png " id="close-btn" /> </div> </div> <div style="position: fixed; right: 16px; bottom: 20px; z-index: 9999;"> <img src=" /static/assets/img/search/cb-search.png " id="search-btn" title="Double click Ctrl" /> </div> <div class="navbar-wrapper"> <nav class="navbar navbar-default navbar-fixed-top" role="navigation"> <div class="container"> <div class="navbar-header page-scroll"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href=" / ">Suzuka Site</a> </div> <div id="navbar" class="navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li><a class="page-scroll" href=" blog/ "></a></li> <li> <a class="page-scroll" href="/blog/">Blog</a></li> <li> <a class="page-scroll" href="/unity/">Unity</a></li> <li> <a class="page-scroll" href="/ai/">AI</a></li> <li> <a class="page-scroll" href="/cg/">CG</a></li> <li> <a class="page-scroll" href="/math/">Math</a></li> <li> <a class="page-scroll" href="/data structure/">Data Structure</a></li> <li> <a class="page-scroll" href="/csharp/">C#</a></li> <li> <a class="page-scroll" href="/python/">Python</a></li> <li> <a class="page-scroll" href="/javascript/">JavaScript</a></li> <li> <a class="page-scroll" href="/dev journal/">Dev Journal</a></li> </ul> </div> </div> </nav> </div> <!--<link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css'>--> <!--<link rel="stylesheet" href="static/css/carousel_style.css">--> <!--<script src="static/js/carousel.js"></script>--> <div id="carouselHacked" class="carousel slide carousel-fade" data-ride="carousel"> <div class="carousel-inner" role="listbox"> <div class="item active"> <!-- Set background for slide in css --> <div class="header-back" style="background-image: url(/static/assets/img/landing/header_1.jpg);" title="first banner image"> </div> </div> <div class="item"> <div class="header-back" style="background-image: url(/static/assets/img/landing/header_2.jpg);" title=""> </div> </div> <div class="item"> <div class="header-back" style="background-image: url(/static/assets/img/landing/header_3.jpg);" title="third banner image"> </div> </div> <div class="item"> <div class="header-back" style="background-image: url(/static/assets/img/landing/header_4.jpg);" title="fourth banner image"> </div> </div> <div class="item"> <div class="header-back" style="background-image: url(/static/assets/img/landing/header_5.jpg);" title="fifth banner image"> </div> </div> <div class="item"> <div class="header-back" style="background-image: url(/static/assets/img/landing/header_6.jpg);" title="sixth banner image"> </div> </div> </div> <!-- Controls --> <a class="left carousel-control" href="#carouselHacked" role="button" data-slide="prev"> <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> <span class="sr-only">Previous</span> </a> <a class="right carousel-control" href="#carouselHacked" role="button" data-slide="next"> <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span> <span class="sr-only">Next</span> </a> </div> <script type="text/x-mathjax-config"> MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']], processEscapes: true } }); </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script> <div class="wrapper wrapper-content animated fadeInRight article"> <div class="row"> <div class="col-lg-10 col-lg-offset-1"> <div class="ibox"> <div class="ibox-content"> <div class="pull-right"> <a class="btn btn-white btn-xs" href="/cg">Cg</a> <a class="btn btn-white btn-xs" href="/unity">Unity</a> </div> <div class="text-center article-title"> <span class="text-muted"><i class="fa fa-clock-o"></i> 23 Jun 2018</span> <h1> Bump Mapping </h1> </div> <div class="ibox-postpadding"> <p>Bump mapping is used for giving models more details with cheap costs by modifying the normal of the model .</p> <p>This method doesn’t change the models detail level, but give us a visual effect that the model has more details after bump mapping.</p> <hr /> <h4 id="1-two-kinds-of--bump-maping">1. Two Kinds of Bump Maping</h4> <p>There are two common ways to do the bump mapping, which are Height Mapping, and Normal Mapping.</p> <p align="center"> <img src="/static/assets/img/blog/hm_nm.png" width="70%" /> </p> <p>Use a height map to simulate the surface displacement. If the color are darker, the surface are lower; if the color are lighter, the surface are higher. The advantage of this using height map is make the height of the surface more obviouse to see. But it is also more expensive performance.</p> <p>Normally we will use normal map to modify the light. In Normal map, it represents the direction of the normal. The range of normal’s component range is [-1,1], but the pixel’s component range is [0,1].So that we need to do a mapping</p> <blockquote> <p>Pixel = (Normal + 1) / 2</p> </blockquote> <p>This will require us to use a inverse function to get the original normal direction after mapping the pixel in the Shader</p> <blockquote> <p>Normal = Pixel x 2 - 1</p> </blockquote> <p align="center"> <img src="/static/assets/img/blog/tangent space and model space.png" width="70%" /> </p> <blockquote> <p>The above image respectively gives us the normal map in the model space and tangent space.</p> </blockquote> <hr /> <h4 id="2-normal-mapping-in-tangent-space">2. Normal Mapping in Tangent Space</h4> <blockquote> <p>The advantage in the tangent space to calculate normal mapping is more efficient don’t need too many conversion.</p> </blockquote> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"MyShader/NormalMapInTangentSpace"</span>
<span class="p">{</span>
 <span class="n">Properties</span>
 <span class="p">{</span>
    <span class="nf">_Color</span><span class="p">(</span><span class="s">"Color"</span><span class="p">,</span><span class="n">Color</span><span class="p">)</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">)</span>
    <span class="nf">_MainTex</span> <span class="p">(</span><span class="s">"Texture"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
    <span class="nf">_BumpMap</span><span class="p">(</span><span class="s">"Normal Map"</span><span class="p">,</span><span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"bump"</span> <span class="p">{}</span>
    <span class="nf">_BumpScale</span><span class="p">(</span><span class="s">"Bump Scale"</span><span class="p">,</span><span class="n">Float</span><span class="p">)</span> <span class="p">=</span> <span class="m">1.0</span>
    <span class="nf">_Specular</span><span class="p">(</span><span class="s">"Specular"</span><span class="p">,</span><span class="n">Color</span><span class="p">)</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">)</span>
    <span class="nf">_Gloss</span><span class="p">(</span><span class="s">"Gloss"</span><span class="p">,</span><span class="nf">Range</span><span class="p">(</span><span class="m">5</span><span class="p">,</span><span class="m">100</span><span class="p">))</span> <span class="p">=</span> <span class="m">5</span>
 <span class="p">}</span>
 <span class="n">SubShader</span>
 <span class="p">{</span>
    <span class="n">Pass</span>
    <span class="p">{</span>
        <span class="n">Tags</span><span class="p">{</span><span class="s">"LightMode"</span> <span class="p">=</span> <span class="s">"ForwardBase"</span><span class="p">}</span>
        <span class="n">CGPROGRAM</span> 
        <span class="err">#</span><span class="n">pragma</span> <span class="n">vertex</span> <span class="n">vert</span>
        <span class="err">#</span><span class="n">pragma</span> <span class="n">fragment</span> <span class="n">frag</span>
        <span class="err">#</span><span class="n">include</span> <span class="s">"Lighting.cginc"</span>

        <span class="n">fixed4</span> <span class="n">_Color</span><span class="p">;</span>
        <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
        <span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>
        <span class="n">sampler2D</span> <span class="n">_BumpMap</span><span class="p">;</span>
        <span class="n">float4</span> <span class="n">_BumpMap_ST</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">_BumpScale</span><span class="p">;</span>
        <span class="n">fixed4</span> <span class="n">_Specular</span><span class="p">;</span>
        <span class="kt">float</span> <span class="n">_Gloss</span><span class="p">;</span>

        <span class="k">struct</span> <span class="nc">a2v</span>
        <span class="p">{</span>
            <span class="n">float4</span> <span class="n">vertex</span> <span class="p">:</span> <span class="n">POSITION</span><span class="p">;</span>
            <span class="n">float3</span> <span class="n">normal</span> <span class="p">:</span> <span class="n">NORMAL</span><span class="p">;</span>

            <span class="c1">// We use TANGENT semantic to describe a float4 type variable tangent,</span>
            <span class="c1">// to tell CG give the vertices' tangent direction to the variable tangent.</span>
            <span class="c1">// compared with normal, tangent is a float4 variable,</span>
            <span class="c1">// because we need tangent.w to determine the binormal's direction</span>
            <span class="n">float4</span> <span class="n">tangent</span> <span class="p">:</span> <span class="n">TANGENT</span><span class="p">;</span>
            <span class="n">float4</span> <span class="n">texcoord</span> <span class="p">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="k">struct</span> <span class="nc">v2f</span>
        <span class="p">{</span>
            <span class="n">float4</span> <span class="n">pos</span> <span class="p">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
            <span class="n">float4</span> <span class="n">uv</span> <span class="p">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
            <span class="n">float3</span> <span class="n">lightDir</span> <span class="p">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>
            <span class="n">float3</span> <span class="n">viewDir</span> <span class="p">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>
        <span class="p">};</span>

        <span class="n">v2f</span> <span class="nf">vert</span><span class="p">(</span><span class="n">a2v</span> <span class="n">v</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
            <span class="n">o</span><span class="p">.</span><span class="n">pos</span> <span class="p">=</span> <span class="nf">UnityObjectToClipPos</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                
            <span class="n">o</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="p">=</span> <span class="n">v</span><span class="p">.</span><span class="n">texcoord</span><span class="p">.</span><span class="n">xy</span> <span class="p">*</span> <span class="n">_MainTex_ST</span><span class="p">.</span><span class="n">xy</span> <span class="p">+</span> <span class="n">_MainTex_ST</span><span class="p">.</span><span class="n">zw</span><span class="p">;</span>
            <span class="n">o</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="p">=</span> <span class="n">v</span><span class="p">.</span><span class="n">texcoord</span><span class="p">.</span><span class="n">xy</span> <span class="p">*</span> <span class="n">_BumpMap_ST</span><span class="p">.</span><span class="n">xy</span> <span class="p">+</span> <span class="n">_BumpMap_ST</span><span class="p">.</span><span class="n">zw</span><span class="p">;</span>
               

            <span class="c1">// Compute the binormal</span>
            <span class="c1">// float3 binormal = cross( normalize(v.normal), normalize(v.tangent.xyz) ) * v.tangent.w;</span>
            <span class="c1">// Construct a matrix which transform vectors from object space to tangent space</span>
            <span class="c1">// float3x3 rotation = float3x3(v.tangent.xyz, binormal, v.normal);</span>
            <span class="c1">// Or just use the built-in macro</span>
            <span class="n">TANGENT_SPACE_ROTATION</span><span class="p">;</span>

            <span class="c1">// Transform the light direction from object space to tangent space</span>
            <span class="n">o</span><span class="p">.</span><span class="n">lightDir</span> <span class="p">=</span> <span class="nf">mul</span><span class="p">(</span><span class="n">rotation</span><span class="p">,</span> <span class="nf">normalize</span><span class="p">(</span><span class="nf">ObjSpaceLightDir</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">))).</span><span class="n">xyz</span><span class="p">;</span>
            <span class="c1">// Transform the view direction from object space to tangent space</span>
            <span class="n">o</span><span class="p">.</span><span class="n">viewDir</span> <span class="p">=</span> <span class="nf">mul</span><span class="p">(</span><span class="n">rotation</span><span class="p">,</span> <span class="nf">normalize</span><span class="p">(</span><span class="nf">ObjSpaceViewDir</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">))).</span><span class="n">xyz</span><span class="p">;</span>
                
            <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">fixed4</span> <span class="nf">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">f</span><span class="p">)</span> <span class="p">:</span> <span class="n">SV_Target</span>
        <span class="p">{</span>
            <span class="n">fixed3</span> <span class="n">tangentLightDir</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">lightDir</span><span class="p">);</span>
            <span class="n">fixed3</span> <span class="n">tangentViewDir</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">viewDir</span><span class="p">);</span>

            <span class="n">fixed4</span> <span class="n">packedNormal</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_BumpMap</span><span class="p">,</span><span class="n">f</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span><span class="p">);</span>

            <span class="c1">// if the texture is not marked as "Normal Map"</span>
            <span class="c1">//fixed3 tangentNormal;</span>
            <span class="c1">//tangentNormal.xy =(packedNormal.xy * 2 - 1) * _BumpScale;</span>
            <span class="c1">//else</span>
            <span class="n">fixed3</span> <span class="n">tangentNormal</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="n">packedNormal</span><span class="p">);</span>
            <span class="n">tangentNormal</span><span class="p">.</span><span class="n">xy</span> <span class="p">*=</span> <span class="n">_BumpScale</span><span class="p">;</span>

            <span class="n">tangentNormal</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="m">1.0</span> <span class="p">-</span> <span class="nf">saturate</span><span class="p">(</span><span class="nf">dot</span><span class="p">(</span><span class="n">tangentNormal</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">tangentNormal</span><span class="p">.</span><span class="n">xy</span><span class="p">)));</span>

            <span class="n">fixed3</span> <span class="n">albedo</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">f</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span><span class="p">).</span><span class="n">rgb</span> <span class="p">*</span> <span class="n">_Color</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
            <span class="n">fixed3</span> <span class="n">ambient</span> <span class="p">=</span> <span class="n">UNITY_LIGHTMODEL_AMBIENT</span><span class="p">.</span><span class="n">xyz</span> <span class="p">*</span> <span class="n">albedo</span><span class="p">;</span>
            <span class="n">fixed3</span> <span class="n">diffuse</span> <span class="p">=</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span> <span class="p">*</span> <span class="n">albedo</span> <span class="p">*</span> <span class="nf">saturate</span><span class="p">(</span><span class="nf">dot</span><span class="p">(</span><span class="n">tangentNormal</span><span class="p">,</span><span class="n">tangentLightDir</span><span class="p">));</span>
            <span class="n">fixed3</span> <span class="n">halfDir</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">tangentLightDir</span> <span class="p">+</span> <span class="n">tangentViewDir</span><span class="p">);</span>
            <span class="n">fixed3</span> <span class="n">specular</span> <span class="p">=</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span> <span class="p">*</span> <span class="n">_Specular</span><span class="p">.</span><span class="n">rgb</span> <span class="p">*</span> <span class="nf">pow</span><span class="p">(</span><span class="nf">saturate</span><span class="p">(</span><span class="nf">dot</span><span class="p">(</span><span class="n">halfDir</span><span class="p">,</span> <span class="n">tangentNormal</span><span class="p">)),</span><span class="n">_Gloss</span><span class="p">);</span>
            <span class="n">fixed3</span> <span class="n">c</span> <span class="p">=</span> <span class="n">ambient</span> <span class="p">+</span> <span class="n">diffuse</span> <span class="p">+</span> <span class="n">specular</span><span class="p">;</span>

            <span class="k">return</span> <span class="nf">fixed4</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="m">1</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">ENDCG</span>
    <span class="p">}</span>
 <span class="p">}</span>
  <span class="n">FallBack</span> <span class="s">"Specular"</span>
<span class="p">}</span>
</code></pre></div></div> <hr /> <h4 id="3-normal-mapping-in-world-space">3. Normal Mapping in World Space</h4> <blockquote> <p>However, from a general point of view, normal mapping in world space is better than in tangent space. For example if we need to use Cubemap to mapping the environment we have to</p> </blockquote> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Shader</span> <span class="s">"MyShader/NormalMapInWorldSpace"</span>
<span class="p">{</span>
    <span class="n">Properties</span> 
    <span class="p">{</span>
        <span class="nf">_Color</span> <span class="p">(</span><span class="s">"Color Tint"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
        <span class="nf">_MainTex</span> <span class="p">(</span><span class="s">"Main Tex"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"white"</span> <span class="p">{}</span>
        <span class="nf">_BumpMap</span> <span class="p">(</span><span class="s">"Normal Map"</span><span class="p">,</span> <span class="m">2D</span><span class="p">)</span> <span class="p">=</span> <span class="s">"bump"</span> <span class="p">{}</span>
        <span class="nf">_BumpScale</span> <span class="p">(</span><span class="s">"Bump Scale"</span><span class="p">,</span> <span class="n">Float</span><span class="p">)</span> <span class="p">=</span> <span class="m">1.0</span>
        <span class="nf">_Specular</span> <span class="p">(</span><span class="s">"Specular"</span><span class="p">,</span> <span class="n">Color</span><span class="p">)</span> <span class="p">=</span> <span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>
        <span class="nf">_Gloss</span> <span class="p">(</span><span class="s">"Gloss"</span><span class="p">,</span> <span class="nf">Range</span><span class="p">(</span><span class="m">8.0</span><span class="p">,</span> <span class="m">256</span><span class="p">))</span> <span class="p">=</span> <span class="m">20</span>
    <span class="p">}</span>
    <span class="n">SubShader</span> 
    <span class="p">{</span>
        <span class="n">Pass</span> 
        <span class="p">{</span> 
            <span class="n">Tags</span> <span class="p">{</span> <span class="s">"LightMode"</span><span class="p">=</span><span class="s">"ForwardBase"</span> <span class="p">}</span>
        
            <span class="n">CGPROGRAM</span>
            
            <span class="err">#</span><span class="n">pragma</span> <span class="n">vertex</span> <span class="n">vert</span>
            <span class="err">#</span><span class="n">pragma</span> <span class="n">fragment</span> <span class="n">frag</span>
            
            <span class="err">#</span><span class="n">include</span> <span class="s">"Lighting.cginc"</span>
            
            <span class="n">fixed4</span> <span class="n">_Color</span><span class="p">;</span>
            <span class="n">sampler2D</span> <span class="n">_MainTex</span><span class="p">;</span>
            <span class="n">float4</span> <span class="n">_MainTex_ST</span><span class="p">;</span>
            <span class="n">sampler2D</span> <span class="n">_BumpMap</span><span class="p">;</span>
            <span class="n">float4</span> <span class="n">_BumpMap_ST</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">_BumpScale</span><span class="p">;</span>
            <span class="n">fixed4</span> <span class="n">_Specular</span><span class="p">;</span>
            <span class="kt">float</span> <span class="n">_Gloss</span><span class="p">;</span>
            
            <span class="k">struct</span> <span class="nc">a2v</span> 
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">vertex</span> <span class="p">:</span> <span class="n">POSITION</span><span class="p">;</span>
                <span class="n">float3</span> <span class="n">normal</span> <span class="p">:</span> <span class="n">NORMAL</span><span class="p">;</span>
                <span class="n">float4</span> <span class="n">tangent</span> <span class="p">:</span> <span class="n">TANGENT</span><span class="p">;</span>
                <span class="n">float4</span> <span class="n">texcoord</span> <span class="p">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
            <span class="p">};</span>
            
            <span class="k">struct</span> <span class="nc">v2f</span> 
            <span class="p">{</span>
                <span class="n">float4</span> <span class="n">pos</span> <span class="p">:</span> <span class="n">SV_POSITION</span><span class="p">;</span>
                <span class="n">float4</span> <span class="n">uv</span> <span class="p">:</span> <span class="n">TEXCOORD0</span><span class="p">;</span>
                <span class="n">float4</span> <span class="n">TtoW0</span> <span class="p">:</span> <span class="n">TEXCOORD1</span><span class="p">;</span>  
                <span class="n">float4</span> <span class="n">TtoW1</span> <span class="p">:</span> <span class="n">TEXCOORD2</span><span class="p">;</span>  
                <span class="n">float4</span> <span class="n">TtoW2</span> <span class="p">:</span> <span class="n">TEXCOORD3</span><span class="p">;</span> 
            <span class="p">};</span>
            
            <span class="n">v2f</span> <span class="nf">vert</span><span class="p">(</span><span class="n">a2v</span> <span class="n">v</span><span class="p">)</span> 
            <span class="p">{</span>
                <span class="n">v2f</span> <span class="n">o</span><span class="p">;</span>
                <span class="n">o</span><span class="p">.</span><span class="n">pos</span> <span class="p">=</span> <span class="nf">mul</span><span class="p">(</span><span class="n">UNITY_MATRIX_MVP</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">);</span>
                
                <span class="n">o</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">xy</span> <span class="p">=</span> <span class="n">v</span><span class="p">.</span><span class="n">texcoord</span><span class="p">.</span><span class="n">xy</span> <span class="p">*</span> <span class="n">_MainTex_ST</span><span class="p">.</span><span class="n">xy</span> <span class="p">+</span> <span class="n">_MainTex_ST</span><span class="p">.</span><span class="n">zw</span><span class="p">;</span>
                <span class="n">o</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span> <span class="p">=</span> <span class="n">v</span><span class="p">.</span><span class="n">texcoord</span><span class="p">.</span><span class="n">xy</span> <span class="p">*</span> <span class="n">_BumpMap_ST</span><span class="p">.</span><span class="n">xy</span> <span class="p">+</span> <span class="n">_BumpMap_ST</span><span class="p">.</span><span class="n">zw</span><span class="p">;</span>
                
                <span class="n">float3</span> <span class="n">worldPos</span> <span class="p">=</span> <span class="nf">mul</span><span class="p">(</span><span class="n">_Object2World</span><span class="p">,</span> <span class="n">v</span><span class="p">.</span><span class="n">vertex</span><span class="p">).</span><span class="n">xyz</span><span class="p">;</span>  
                <span class="n">fixed3</span> <span class="n">worldNormal</span> <span class="p">=</span> <span class="nf">UnityObjectToWorldNormal</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">normal</span><span class="p">);</span>  
                <span class="n">fixed3</span> <span class="n">worldTangent</span> <span class="p">=</span> <span class="nf">UnityObjectToWorldDir</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">xyz</span><span class="p">);</span>  
                <span class="n">fixed3</span> <span class="n">worldBinormal</span> <span class="p">=</span> <span class="nf">cross</span><span class="p">(</span><span class="n">worldNormal</span><span class="p">,</span> <span class="n">worldTangent</span><span class="p">)</span> <span class="p">*</span> <span class="n">v</span><span class="p">.</span><span class="n">tangent</span><span class="p">.</span><span class="n">w</span><span class="p">;</span> 
                
                <span class="c1">// Compute the matrix that transform directions from tangent space to world space</span>
                <span class="c1">// Put the world position in w component for optimization</span>
                <span class="n">o</span><span class="p">.</span><span class="n">TtoW0</span> <span class="p">=</span> <span class="nf">float4</span><span class="p">(</span><span class="n">worldTangent</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">worldBinormal</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">worldNormal</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">worldPos</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">TtoW1</span> <span class="p">=</span> <span class="nf">float4</span><span class="p">(</span><span class="n">worldTangent</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">worldBinormal</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">worldNormal</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">worldPos</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
                <span class="n">o</span><span class="p">.</span><span class="n">TtoW2</span> <span class="p">=</span> <span class="nf">float4</span><span class="p">(</span><span class="n">worldTangent</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">worldBinormal</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">worldNormal</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">worldPos</span><span class="p">.</span><span class="n">z</span><span class="p">);</span>
                
                <span class="k">return</span> <span class="n">o</span><span class="p">;</span>
            <span class="p">}</span>
            
            <span class="n">fixed4</span> <span class="nf">frag</span><span class="p">(</span><span class="n">v2f</span> <span class="n">i</span><span class="p">)</span> <span class="p">:</span> <span class="n">SV_Target</span> 
            <span class="p">{</span>
                <span class="c1">// Get the position in world space      </span>
                <span class="n">float3</span> <span class="n">worldPos</span> <span class="p">=</span> <span class="nf">float3</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">TtoW0</span><span class="p">.</span><span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">TtoW1</span><span class="p">.</span><span class="n">w</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">TtoW2</span><span class="p">.</span><span class="n">w</span><span class="p">);</span>
                <span class="c1">// Compute the light and view dir in world space</span>
                <span class="n">fixed3</span> <span class="n">lightDir</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="nf">UnityWorldSpaceLightDir</span><span class="p">(</span><span class="n">worldPos</span><span class="p">));</span>
                <span class="n">fixed3</span> <span class="n">viewDir</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="nf">UnityWorldSpaceViewDir</span><span class="p">(</span><span class="n">worldPos</span><span class="p">));</span>
                
                <span class="c1">// Get the normal in tangent space</span>
                <span class="n">fixed3</span> <span class="n">bump</span> <span class="p">=</span> <span class="nf">UnpackNormal</span><span class="p">(</span><span class="nf">tex2D</span><span class="p">(</span><span class="n">_BumpMap</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">zw</span><span class="p">));</span>
                <span class="n">bump</span><span class="p">.</span><span class="n">xy</span> <span class="p">*=</span> <span class="n">_BumpScale</span><span class="p">;</span>
                <span class="n">bump</span><span class="p">.</span><span class="n">z</span> <span class="p">=</span> <span class="nf">sqrt</span><span class="p">(</span><span class="m">1.0</span> <span class="p">-</span> <span class="nf">saturate</span><span class="p">(</span><span class="nf">dot</span><span class="p">(</span><span class="n">bump</span><span class="p">.</span><span class="n">xy</span><span class="p">,</span> <span class="n">bump</span><span class="p">.</span><span class="n">xy</span><span class="p">)));</span>
                <span class="c1">// Transform the narmal from tangent space to world space</span>
                <span class="n">bump</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="nf">half3</span><span class="p">(</span><span class="nf">dot</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">TtoW0</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">bump</span><span class="p">),</span> <span class="nf">dot</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">TtoW1</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">bump</span><span class="p">),</span> <span class="nf">dot</span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">TtoW2</span><span class="p">.</span><span class="n">xyz</span><span class="p">,</span> <span class="n">bump</span><span class="p">)));</span>
                
                <span class="n">fixed3</span> <span class="n">albedo</span> <span class="p">=</span> <span class="nf">tex2D</span><span class="p">(</span><span class="n">_MainTex</span><span class="p">,</span> <span class="n">i</span><span class="p">.</span><span class="n">uv</span><span class="p">).</span><span class="n">rgb</span> <span class="p">*</span> <span class="n">_Color</span><span class="p">.</span><span class="n">rgb</span><span class="p">;</span>
                
                <span class="n">fixed3</span> <span class="n">ambient</span> <span class="p">=</span> <span class="n">UNITY_LIGHTMODEL_AMBIENT</span><span class="p">.</span><span class="n">xyz</span> <span class="p">*</span> <span class="n">albedo</span><span class="p">;</span>
                
                <span class="n">fixed3</span> <span class="n">diffuse</span> <span class="p">=</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span> <span class="p">*</span> <span class="n">albedo</span> <span class="p">*</span> <span class="nf">max</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="nf">dot</span><span class="p">(</span><span class="n">bump</span><span class="p">,</span> <span class="n">lightDir</span><span class="p">));</span>

                <span class="n">fixed3</span> <span class="n">halfDir</span> <span class="p">=</span> <span class="nf">normalize</span><span class="p">(</span><span class="n">lightDir</span> <span class="p">+</span> <span class="n">viewDir</span><span class="p">);</span>
                <span class="n">fixed3</span> <span class="n">specular</span> <span class="p">=</span> <span class="n">_LightColor0</span><span class="p">.</span><span class="n">rgb</span> <span class="p">*</span> <span class="n">_Specular</span><span class="p">.</span><span class="n">rgb</span> <span class="p">*</span> <span class="nf">pow</span><span class="p">(</span><span class="nf">max</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="nf">dot</span><span class="p">(</span><span class="n">bump</span><span class="p">,</span> <span class="n">halfDir</span><span class="p">)),</span> <span class="n">_Gloss</span><span class="p">);</span>
                
                <span class="k">return</span> <span class="nf">fixed4</span><span class="p">(</span><span class="n">ambient</span> <span class="p">+</span> <span class="n">diffuse</span> <span class="p">+</span> <span class="n">specular</span><span class="p">,</span> <span class="m">1.0</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="n">ENDCG</span>
        <span class="p">}</span>
    <span class="p">}</span> 
    <span class="n">FallBack</span> <span class="s">"Specular"</span>
<span class="p">}</span>
</code></pre></div></div> <hr /> <blockquote> <p><strong>End –Cheng Gu</strong></p> </blockquote> </div> <hr> <div class="row"> <div class="col-md-6"> <h5 style="display: inline;">Tags:</h5> <button class="btn btn-white btn-xs" type="button">Unity</button> <button class="btn btn-white btn-xs" type="button">Shader</button> <button class="btn btn-white btn-xs" type="button">Math</button> <button class="btn btn-white btn-xs" type="button">CG</button> </div> <div class="col-md-6"> <div class="small text-right"> <div> </div> </div> </div> </div> <br> <div class="row"> <div class="col-lg-12"> <!-- donate --> <br> <!-- share --> <div class="a2a_kit a2a_kit_size_32 a2a_default_style"> <a class="a2a_dd" href="https://www.addtoany.com/share"></a> <a class="a2a_button_facebook"></a> <a class="a2a_button_twitter"></a> <a class="a2a_button_google_plus"></a> <a class="a2a_button_linkedin"></a> <a class="a2a_button_email"></a> <a class="a2a_button_wechat"></a> <a class="a2a_button_sina_weibo"></a> <a class="a2a_button_pocket"></a> </div> <script> var a2a_config = a2a_config || {}; a2a_config.color_main = "D7E5ED"; a2a_config.color_border = "AECADB"; a2a_config.color_link_text = "333333"; a2a_config.color_link_text_hover = "333333"; </script> <script async src="https://static.addtoany.com/menu/page.js"></script> <br> <!-- comment --> </div> </div> </div> </div> </div> </div> </div> <!-- Google analytics --> <!-- GrowingIO --> </body> </html>
