---
layout: post
title:  "PBR Theory (CG)"
date:   2019-05-01
categories: [Cg]
tags: [CG]
icon: icon-splatter
---

# Table of Contents
### 1. [**什么是PBR? 为什么要用PBR?**](#1)
### 2. [**光的原理**](#2)
### 3. [**辐射测量学物理量**](#3)
### 4. [**渲染方程**](#4)
### 5. [**精确光源**](#5)
### 6. [**双向反射分布函数(BRDF)**](#6)

<a name="1"></a>

<br/><br/>

---

<br/><br/>

# 1. 什么是PBR? 为什么要用PBR?

**基于物理的渲染(physical based rendering, PBR)**是计算机图形学中的一种方法，它使用具有物理意义的参数和真实物理定律来渲染逼真的照片。

> 使用PBR的**原因**主要有两种:
1. 渲染出更真实的画面.
2. 更方便于美术人员调整参数以得到满意的效果.

<br/><br/>

<p align="center">     
<img src="/static/assets/img/blog/pbr.jpg" width="70%">
</p>

> PBR基础理论的概括:
1. 微平面理论（Microfacet Theory）: 微平面理论是将物体表面建模成做无数微观尺度上有随机朝向的理想镜面反射的小平面（microfacet）的理论。在实际的PBR 工作流中，这种物体表面的不规则性用粗糙度贴图或者高光度贴图来表示。
2. 能量守恒（Energy Conservation）: 出射光线的能量永远不能超过入射光线的能量。随着粗糙度的上升镜面反射区域的面积会增加，作为平衡，镜面反射区域的平均亮度则会下降。
3. 菲涅尔反射（Fresnel Reflectance）: 光线以不同角度入射会有不同的反射率。相同的入射角度，不同的物质也会有不同的反射率。万物皆有菲涅尔反射。F0是即 0 度角入射的菲涅尔反射值。大多数非金属的F0范围是0.02~0.04，大多数金属的F0范围是0.7~1.0。
4. 线性空间（Linear Space）: 光照计算必须在线性空间完成，shader 中输入的gamma空间的贴图比如漫反射贴图需要被转成线性空间，在具体操作时需要根据不同引擎和渲染器的不同做不同的操作。而描述物体表面属性的贴图如粗糙度，高光贴图，金属贴图等必须保证是线性空间。
5. 色调映射（Tone Mapping）: 是将宽范围的照明级别拟合到屏幕有限色域内的过程。因为基于HDR渲染出来的亮度值会超过显示器能够显示最大亮度，所以需要使用色调映射，将光照结果从HDR转换为显示器能够正常显示的LDR。
6. 物质的光学特性（Substance Optical Properties）: 现实世界中有不同类型的物质可分为三大类：绝缘体（Insulators），半导体（semi-conductors）和导体（conductors）。在渲染和游戏领域，我们一般只对其中的两个感兴趣：导体（金属）和绝缘体（电解质，非金属）。其中非金属具有单色/灰色镜面反射颜色。而金属具有彩色的镜面反射颜色。即非金属的F0是一个float。而金属的F0是一个float3，如下图。

<p align="center">     
<img src="/static/assets/img/blog/substance_optical_properties.jpg" width="50%">
</p>

<a name="2"></a>


<br/><br/>

--- 

<br/><br/>

# 2. 光的原理

**光线**是由光源发射出来的,与物体相交后一部分会被吸收(absorption),另一部分会被散射(scattering).
**菲涅尔等式**描述的是有多少百分比的光会被反射,剩余百分比的光则会被散射.
**次表面散射光():** 非金属材质会出现吸收和散射两种现象, 背散射出去的光被称为次表面散射光(Subsurface-Scattered Light). (而金属材质具有很高的吸收系数,所有被折射的光会被立即吸收,被金属内部的自由电子转化成其他形式的能量.所以几乎没有散射)

<p align="center">
<img src="/static/assets/img/blog/flat_surface.png" width="40%">
<img src="/static/assets/img/blog/v2-non-flat_surface.jpg" width="40%">
</p>


<a name="3"></a>

<br/><br/>

--- 

<br/><br/>

# 3. 辐射测量学物理量

**立体角(solid angle):** 立体角是以圆锥体的顶点为心,半径为1的球面被锥面所截得的面积来度量的,度量单位称为“立体弧度”.和平面角的定义类似.在平面上我们定义一段弧微分S与其矢量半径r的比值为其对应的圆心角记作 $ dθ=\frac{ds}{r} $, 所以整个圆周对应的圆心角就是2π；与此类似,定义立体角为曲面上面积微元ds与其矢量半径的二次方的比值为此面微元对应的立体角记作$dw=\frac{ds}{r^2}$. 由此可得,闭合球面的立体角都是4π. (球面度(sr)是立体角的国际单位)

<p align="center">     
<img src="/static/assets/img/blog/solidangle.png" width="20%">
</p>

<br/>

**光通量(luminous flux):** 指人眼所能感觉到的辐射功率，它等于单位时间内某一波段的辐射能量和该波段的相对视见率的乘积。(单位:$W$).用 $\phi$ 表示

```
光通量计算：

灯具实际光通量（灯具流明）/（单颗光源光通量*光源数量），说浅一点就是灯具实际发出的光通量除以灯具应该发出的光通量。

例：灯具有五颗1W大功率光源，单颗大功光源光通量为80LM，整灯应该发出80LM*5PCS=400LM。但当组装成灯具后，实际灯具光通量只有350LM了。这就是发光效率。那此灯的光效就是350LM/400LM=87.5%
```

<br/>

**辐射照度(irradiance):** 单位面积的光通(单位:$W/m^2$). $E = \frac{d\phi}{dA}$ (dA表示接收面)

<br/>

**光强(intensity):** 单位立体角光通(单位$W/sr$). $I =\frac{d\phi}{dw}$ 

<br/>

**辐射亮度(radiance):** 表示单位面积,单位方向上光源的辐射通量(单位$W/m^2/sr$). 
$$L = \frac{d\phi}{dw*dA*cos\theta}$$

<p align="center">
<img src="/static/assets/img/blog/radiance.png" width="60%">
</p>

<p align="center">
<img src="/static/assets/img/blog/radiance2.png" width="60%">
</p>

<a name="4"></a>
<br/><br/>

--- 

<br/><br/>

# 4. 渲染方程

​渲染方程是计算机图形学的核心公式，当去掉其中的自发光项 *$L_e(v)$*后，剩余的部分就是著名的反射等式(**ReflectanceEquation**)。

​想象我们现在要计算表面上某点的出射辐射率，我们已知到该点的观察方向，该点的出射辐射率是由从许多不同方向的入射辐射率叠加后的结果。其中，$f(w_i, v)$表示了不同方向的入射光在该观察方向上的权重分布。我们把这些不同方向的光辐射率$L_i(w_i)$部分)乘以观察方向上所占的权重部分$f(w_i,v)$，再乘以它们在该表面的投影结果($n \cdot w_i$)部分，最后再把这些值加起来(即做积分)就是最后的出射辐射率。

自从James Kajiya发明了渲染方程, 我们不用再靠各种各样的想法以及测试来尝试进行各种渲染, 我们有了统一的目标,那就是更好的求解渲染方程. 公式如下:

$$L_o(v) = L_e(v)+\int_{\Omega}{f(w_i,v)L_i(w_i)(n\cdot w_i)dw_i}$$


> $L_o (v)$: 由当前点出发到观察点(v)的总光照
<br/>$L_e(v)$: 由当前点发出的自发光部分
<br/>$\int_{\Omega}$: 对以当前点为球心的半球内的入射光照进行无穷小的累积,即求积分.
<br/>$f(w_i,v)$: 描述了从某个方向出发经过当前点反射后,有多少光照被反射到了观察方向.
<br/>$L_i(w_i)$: 从某个方向出发,到达当前点的光照.
<br/>($n\cdot w_i$): 由于入射角度二队从该方向出发的光照亮度所造成的衰减.
<br/>$dw_i$: 入射方向位于以当前点为球心的半球内的某个入射光照.  
```

<p align="center">     
<img src="/static/assets/img/blog/rendering equation.png" width="50%">
</p>

在实时渲染中，自发光项通常就是直接加上某个自发光值。除此之外，积分累加部分在实时渲染中也基本无法实现，因此积分部分通常会被若干***精确光源***的叠加所代替，而不需要计算所有入射光线在半球面上的积分。

<a name="5"></a>
<br/><br/>

--- 

<br/><br/>

# 4. 精确光源

在真实的物理世界中,所有的光源都是有面积概念的,即所谓的**面光源**. 由于面光源的光照计算通常要耗费大量的时间,因此在实时渲染中, 我们通常会使用精确光源(punctual light sources). 图形学中常见的精确光源有点光源, 平行光, 和聚光灯等. 这些精确光源被认为是大小无限小而且方向是确定的. 尽管这不符合真实的物理意义,但是它们在大多是情况下都能得到较好的渲染效果.

>好处: 大大简化反射等式(Reflection Equation)

对于**一个精确光源**,可以用一下等式来计算它在某个观察方向(v)上的出射辐射率:$$L_o(v) = \pi f(l_c,v)c_{light}(n\cdot l_c)$$


> $l_c$: 表示了它的方向
<br/>
$c_{light}$:表示了它的颜色6


然而对于**多个精确光源**, 只要累积相加结果即可:$$L_o(v) = \sum_{i=0}^nL_o^i(v) = \sum_{i=0}^n\pi f(l_c^i,v)c_{light}(n\cdot l_c^i)$$

*$f(l_c^i,v)$*实际上􏰁述了当前点是如何与入射光线进行交互的:当给定某个入射方向的入射光后，有多少百分比的光照被反射到了观察方向上。在图形学中，这一项有一个专门的名字，那就是**双向反射分布函数**，即 **BRDF**。

<a name="6"></a>
<br/><br/>

--- 

<br/><br/>

# 4. 双向反射分布函数(BRDF)

**BRDF(Bidirectional Reflectance Distribution Function)**描述了物体表面一点是如何和光进行交互的. 大多数情况下,BRDF可以用$f(l,v)$ 来表示,其中 $l$ 为入社方向, $v$ 为观察方向(双向的含义). 分为**各向同性(isotropic)**的BRDF, 和**各项异性(Anisotropic)**的BRDF. 

各向同性和各向异性是指物理性质在不同的方向进行测量得到的结论。如果各个方向的测量结果是相同的，说明其物理性质与取向无关，就称为各向同性。如果物理性质和取向密切相关，不同取向的测量结果迥异，就称为各向异性。

> 例如, 绕着表面法线旋转入射方向或观察方向并不会影响BRDF的结果,那么这种BRDF被称为是各项同性,反之则是各项异性.

<br/>

BRDF 有两种理解方式:
1. 当给定入射角度后，BRDF 可以给出所有出射方向上的反射和散射光线的相对分布情况.
2. 当给定观察方向(即出射方向)后，BRDF 可以给出从所有入射方向到该出射方向的光线分布.
> 简单的说就是当一束光线沿着入射方向$l$ 到达表面某点时, $f(l,v)$ 表示了有多少能量被反射到了观察方向$v$ 上.

需要满足**两个特性**:

1. 交换律(**reciprocity**): 当交换 ***l*** 和 ***v*** 的值后，BRDF 的值不变

$$f(l,v) = f(v,l)$$

2. 能量守恒(**energy conservation**): 表面反射的能量不能超过入射的光能

$$\int_{\pi}f(l,v)(n\cdot l)dw_o\le1$$

基于这些理论, BRDF 可以用于描述两种不同的物理现象:**表面反射**和**次表面散射**。针对每种现象，BRDF通常会包含一个单独的部分来描述它们— 用于描述表面反射的部分被称为高光反射项(**specular term**)，以及用于描述次表面散射的漫反射项(**diffuse term**). (如下图)

<p align="center">     
<img src="/static/assets/img/blog/brdf.png" width="50%">
</p>


---

# References
 - Unity Shader入门精要 by 冯乐乐
 - 东拼西凑PBR：PBR基础 by 杨超
 - 基于物理的渲染通识课 by Razor Yhang
 - Physically based rendering - Wikipedia
 - PBR浅析 - Bob Blog
 - 浅墨的游戏编程 - 毛星云

>**End --Cheng Gu**

